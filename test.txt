// /frontend/js/main.js

let allProducts = [];
const exchangeRate = 3.8;

// Elementos que podr√≠an NO existir si todav√≠a no tienes el modal de pago en el HTML
const qrModal = document.getElementById("qrModal");
const qrPriceText = document.getElementById("qrPriceText");
const notifyBtn = document.getElementById("notifyWhatsAppBtn");
const yapePlinInfo = document.getElementById("yapePlinNumber");
const payMethodLabel = document.getElementById("payMethodLabel");
const closeModalBtn = document.getElementById("closeModalBtn");

// Filtros
const searchInput = document.getElementById("search-input");
const stockToggle = document.getElementById("stockOnlyToggle");

let currentProduct = null;
let currentMethod = null;

/* ================== Cerrar modal con animaci√≥n (si existe) ================== */
if (closeModalBtn && qrModal) {
  closeModalBtn.addEventListener("click", () => {
    qrModal.classList.add("dialog-closing");
    qrModal.addEventListener(
      "animationend",
      () => {
        qrModal.classList.remove("dialog-closing");
        qrModal.close();
      },
      { once: true }
    );
  });
}

/* ================== M√©todos de pago (si usas modal) ================== */
function setPayment(method, colorClass) {
  if (!notifyBtn) return;
  currentMethod = method;
  if (payMethodLabel) payMethodLabel.textContent = method;

  notifyBtn.className = `block mt-6 w-full text-white py-2 rounded text-center font-semibold ${colorClass} hover:${colorClass.replace("500","600")}`;
  notifyBtn.classList.remove("pointer-events-none", "opacity-50", "bg-gray-800");
  notifyBtn.disabled = false;
  notifyBtn.textContent = "‚úÖ Ya pagu√© - Notificar por WhatsApp";
  updateWhatsAppLink();
}

function showIzipay() {
  hideAllQRs();
  const el = document.getElementById("izipayQR");
  if (el) el.classList.remove("hidden");
  if (yapePlinInfo) yapePlinInfo.classList.add("hidden");
  setPayment("Izipay", "bg-yellow-500");
}
function showBinance() {
  hideAllQRs();
  const el = document.getElementById("binanceQR");
  if (el) el.classList.remove("hidden");
  if (yapePlinInfo) yapePlinInfo.classList.add("hidden");
  setPayment("Binance", "bg-gray-700");
}
function showYape() {
  hideAllQRs();
  const el = document.getElementById("yapeQR");
  if (el) el.classList.remove("hidden");
  if (yapePlinInfo) yapePlinInfo.classList.remove("hidden");
  setPayment("Yape", "bg-fuchsia-700");
}
function showPlin() {
  hideAllQRs();
  const el = document.getElementById("plinQR");
  if (el) el.classList.remove("hidden");
  if (yapePlinInfo) yapePlinInfo.classList.remove("hidden");
  setPayment("Plin", "bg-blue-700");
}
function hideAllQRs() {
  ["izipayQR", "binanceQR", "yapeQR", "plinQR"].forEach((id) => {
    const el = document.getElementById(id);
    if (el) el.classList.add("hidden");
  });
  if (yapePlinInfo) yapePlinInfo.classList.add("hidden");
}

/* ================== Carga de productos ================== */
// Reemplaza tu bloque DOMContentLoaded por este:

document.addEventListener("DOMContentLoaded", () => {
  // primera carga
  loadProducts();

  // filtros
  if (searchInput) searchInput.addEventListener("input", applyFilters);
  if (stockToggle) stockToggle.addEventListener("change", applyFilters);

  // cuando escribas/borres slug, recarga desde el backend
  const slugInput = document.getElementById("shop-slug");
  if (slugInput) {
    let t;
    slugInput.addEventListener("input", () => {
      clearTimeout(t);
      t = setTimeout(() => loadProducts(), 300); // debounce
    });
  }
});

// nueva funci√≥n
function loadProducts() {
  const slugValue = (document.getElementById("shop-slug")?.value || "").trim();
  const qValue = (searchInput?.value || "").trim();

  // decide endpoint en base al slug
  let url = "http://127.0.0.1:8000/products";
  if (slugValue) {
    // soporta search en el backend si lo agregaste
    const qs = qValue ? `?q=${encodeURIComponent(qValue)}` : "";
    url = `http://127.0.0.1:8000/shops/${encodeURIComponent(slugValue)}/products${qs}`;
  }

  fetch(url)
    .then((r) => r.json())
    .then((products) => {
      allProducts = products || [];
      applyFilters(); // aplica ‚Äúsolo stock‚Äù + b√∫squeda local
    })
    .catch((err) => {
      console.error("Error al obtener productos:", err);
      allProducts = [];
      renderProducts([]);
    });
}

function applyFilters() {
  const query = (searchInput?.value || "").trim().toLowerCase();
  const stockOnly = !!stockToggle?.checked;

  let filtered = allProducts.filter(
    (p) =>
      p.name.toLowerCase().includes(query) ||
      p.description.toLowerCase().includes(query)
  );

  if (stockOnly) filtered = filtered.filter((p) => p.stock > 0);

  const sorted = [...filtered].sort((a, b) => (b.promotion === true) - (a.promotion === true));
  renderProducts(sorted);
}

function renderProducts(products) {
  const grid = document.getElementById("products-grid");
  if (!grid) return;
  grid.innerHTML = "";

  products.forEach((product) => {
    const card = document.createElement("div");
    card.className = `
      relative
      ${product.promotion ? "glow-card" : ""}
      bg-white rounded-2xl hover:scale-[1.02]
      transition-transform duration-300
      p-4 flex flex-col w-full max-w-xs
      opacity-0 translate-y-4
    `;

    if (product.promotion) {
      const promoBadge = document.createElement("div");
      promoBadge.textContent = "üéâ ¬°PROMO!";
      promoBadge.className = "absolute top-2 left-2 bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded shadow";
      card.appendChild(promoBadge);
    }

    const image = document.createElement("img");
    image.src = product.image_url;
    image.alt = product.name;
    image.className = "w-full h-40 object-cover rounded-lg mb-3";

    const name = document.createElement("h2");
    name.className = "text-lg font-semibold mb-1";

    const query = (searchInput?.value || "").trim().toLowerCase();
    if (query && product.name.toLowerCase().includes(query)) {
      name.innerHTML = product.name.replace(new RegExp(`(${query})`, "gi"), "<mark>$1</mark>");
    } else {
      name.textContent = product.name;
    }

    const desc = document.createElement("p");
    desc.textContent = product.description;
    desc.className = "text-sm text-gray-600 mb-2 w-full overflow-hidden whitespace-nowrap text-ellipsis";

    const toggleBtn = document.createElement("button");
    toggleBtn.textContent = "Ver m√°s";
    toggleBtn.className = "text-sm text-blue-600 underline mb-2 text-left w-fit hidden transition-opacity duration-200";
    toggleBtn.style.minHeight = "1.5rem";

    requestAnimationFrame(() => {
      setTimeout(() => {
        toggleBtn.classList.remove("hidden");
        toggleBtn.style.visibility = desc.scrollWidth > desc.clientWidth ? "visible" : "hidden";
        card.classList.remove("opacity-0", "translate-y-4");
        card.classList.add("opacity-100", "translate-y-0");
      }, 0);
    });

    toggleBtn.addEventListener("click", () => {
      const isTruncated = desc.classList.contains("overflow-hidden");
      desc.className = isTruncated
        ? "text-sm text-gray-600 mb-2 w-full whitespace-normal"
        : "text-sm text-gray-600 mb-2 w-full overflow-hidden whitespace-nowrap text-ellipsis";
      toggleBtn.textContent = isTruncated ? "Ver menos" : "Ver m√°s";
    });

    const price = document.createElement("p");
    price.className = "text-red-600 text-lg font-bold mb-3";
    price.textContent = `S/ ${product.price.toFixed(2)}`;

    const stock = document.createElement("p");
    stock.className = `text-sm font-semibold mb-1 ${product.stock <= 0 ? "text-red-600" : "text-gray-700"}`;
    stock.textContent = product.stock <= 0 ? "Sin stock" : `Stock: ${product.stock}`;

    // Bot√≥n WhatsApp (de momento un n√∫mero fijo de pruebas)
    const whatsappBtn = document.createElement("a");
    whatsappBtn.href = `https://wa.me/51922540931?text=Hola, estoy interesado en el producto: ${encodeURIComponent(product.name)}`;
    whatsappBtn.target = "_blank";
    whatsappBtn.rel = "noopener noreferrer";
    whatsappBtn.className = "bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-4 rounded text-center mt-1";
    whatsappBtn.textContent = "WhatsApp";

    // Bot√≥n QR (si tienes modal)
    const qrBtn = document.createElement("button");
    qrBtn.textContent = "Pagar por QR";
    qrBtn.className = `text-white font-semibold py-1 px-4 rounded text-center mt-1 ${product.stock <= 0 ? "bg-gray-400 cursor-not-allowed" : "bg-purple-600 hover:bg-purple-700"}`;
    qrBtn.disabled = product.stock <= 0;
    qrBtn.onclick = () => {
      if (!qrModal || product.stock <= 0) return;

      currentProduct = product;
      currentMethod = null;
      hideAllQRs();
      qrModal.showModal();

      if (qrPriceText) {
        qrPriceText.innerHTML = `S/ ${product.price.toFixed(2)}<br><span class='text-sm text-gray-600'>(~ ${(product.price / exchangeRate).toFixed(2)} USDT)</span>`;
      }

      if (notifyBtn) {
        notifyBtn.disabled = true;
        notifyBtn.textContent = "‚ö†Ô∏è Selecciona un m√©todo de pago";
        notifyBtn.className = "block mt-6 w-full bg-gray-800 text-white py-2 rounded text-center font-semibold opacity-50 pointer-events-none";
        notifyBtn.href = "#";
      }
    };

    const buttonContainer = document.createElement("div");
    buttonContainer.className = "flex flex-col gap-2 mt-2";
    buttonContainer.appendChild(whatsappBtn);
    buttonContainer.appendChild(qrBtn);

    card.appendChild(image);
    card.appendChild(name);
    card.appendChild(desc);
    card.appendChild(toggleBtn);
    card.appendChild(price);
    card.appendChild(stock);
    card.appendChild(buttonContainer);

    grid.appendChild(card);
  });
}

/* ================== Link de WhatsApp del modal ================== */
function updateWhatsAppLink() {
  if (!notifyBtn) return;

  if (!currentProduct || !currentMethod) {
    notifyBtn.href = "#";
    notifyBtn.textContent = "‚ö†Ô∏è Selecciona un m√©todo de pago";
    notifyBtn.className = "block mt-6 w-full bg-gray-800 text-white py-2 rounded text-center font-semibold opacity-50 pointer-events-none";
    return;
  }

  const text = `Hola, ya realic√© el pago por *${currentMethod}* del producto *${currentProduct.name}* por el monto de S/ ${currentProduct.price.toFixed(2)}. Adjunto comprobante.`;
  notifyBtn.href = `https://wa.me/51922540931?text=${encodeURIComponent(text)}`;
  notifyBtn.textContent = "‚úÖ Ya pagu√© - Notificar por WhatsApp";
  notifyBtn.className = "block mt-6 w-full text-white py-2 rounded text-center font-semibold bg-green-600 hover:bg-green-700";
  notifyBtn.classList.remove("pointer-events-none", "opacity-50");
}

/* Cerrar modal al hacer clic en "Ya pagu√©" (si existe) */
if (notifyBtn && qrModal) {
  notifyBtn.addEventListener("click", (e) => {
    if (!currentProduct || !currentMethod) {
      e.preventDefault();
      return;
    }
    qrModal.classList.add("dialog-closing");
    qrModal.addEventListener(
      "animationend",
      () => {
        qrModal.classList.remove("dialog-closing");
        qrModal.close();
      },
      { once: true }
    );
  });
}
