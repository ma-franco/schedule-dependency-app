// /frontend/js/main.js

/* ================== Estado global ================== */
let allProducts = [];
const exchangeRate = 3.8;

/* ================== Helpers ================== */
// Muestra un mensaje de error en el grid cuando algo sale mal
function showError(msg) {
  const grid = document.getElementById("products-grid");
  if (!grid) return;
  grid.innerHTML = `<div class="text-white bg-red-600/80 p-3 rounded text-center">${msg}</div>`;
}

// Debounce simple para inputs
function debounce(fn, ms = 300) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), ms);
  };
}

/* ================== Referencias de DOM (algunas pueden no existir) ================== */
// Modal y controles de pago (opcionales)
const qrModal       = document.getElementById("qrModal");
const qrPriceText   = document.getElementById("qrPriceText");
const notifyBtn     = document.getElementById("notifyWhatsAppBtn");
const yapePlinInfo  = document.getElementById("yapePlinNumber");
const payMethodLabel= document.getElementById("payMethodLabel");
const closeModalBtn = document.getElementById("closeModalBtn");

// Filtros
const searchInput = document.getElementById("search-input");
const stockToggle = document.getElementById("stockOnlyToggle");
const slugInput   = document.getElementById("shop-slug");

let currentProduct = null;
let currentMethod  = null;

/* ================== Modal: cerrar con animaciÃ³n (si existe) ================== */
if (closeModalBtn && qrModal) {
  closeModalBtn.addEventListener("click", () => {
    qrModal.classList.add("dialog-closing");
    qrModal.addEventListener(
      "animationend",
      () => {
        qrModal.classList.remove("dialog-closing");
        qrModal.close();
      },
      { once: true }
    );
  });
}

/* ================== MÃ©todos de pago (si usas modal) ================== */
function setPayment(method, colorClass) {
  if (!notifyBtn) return;
  currentMethod = method;
  if (payMethodLabel) payMethodLabel.textContent = method;

  notifyBtn.className = `block mt-6 w-full text-white py-2 rounded text-center font-semibold ${colorClass} hover:${colorClass.replace("500","600")}`;
  notifyBtn.classList.remove("pointer-events-none", "opacity-50", "bg-gray-800");
  notifyBtn.disabled = false;
  notifyBtn.textContent = "âœ… Ya paguÃ© - Notificar por WhatsApp";
  updateWhatsAppLink();
}

function hideAllQRs() {
  ["izipayQR","binanceQR","yapeQR","plinQR"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add("hidden");
  });
  if (yapePlinInfo) yapePlinInfo.classList.add("hidden");
}

function showIzipay(){ hideAllQRs(); document.getElementById("izipayQR")?.classList.remove("hidden"); yapePlinInfo?.classList.add("hidden"); setPayment("Izipay","bg-yellow-500"); }
function showBinance(){ hideAllQRs(); document.getElementById("binanceQR")?.classList.remove("hidden"); yapePlinInfo?.classList.add("hidden"); setPayment("Binance","bg-gray-700"); }
function showYape(){ hideAllQRs(); document.getElementById("yapeQR")?.classList.remove("hidden"); yapePlinInfo?.classList.remove("hidden"); setPayment("Yape","bg-fuchsia-700"); }
function showPlin(){ hideAllQRs(); document.getElementById("plinQR")?.classList.remove("hidden"); yapePlinInfo?.classList.remove("hidden"); setPayment("Plin","bg-blue-700"); }

/* ================== Carga inicial y listeners ================== */
document.addEventListener("DOMContentLoaded", () => {
  loadProducts(); // primera carga

  if (searchInput) searchInput.addEventListener("input", applyFilters);
  if (stockToggle) stockToggle.addEventListener("change", applyFilters);

  if (slugInput) {
    slugInput.addEventListener("input", debounce(() => loadProducts(), 350));
  }
});

/* ================== Fetch productos (con slug opcional) ================== */
function loadProducts() {
  const slugValue = (slugInput?.value || "").trim();
  const qValue    = (searchInput?.value || "").trim();

  let url = "http://127.0.0.1:8000/products";
  if (slugValue) {
    const qs = qValue ? `?q=${encodeURIComponent(qValue)}` : "";
    url = `http://127.0.0.1:8000/shops/${encodeURIComponent(slugValue)}/products${qs}`;
  }

  fetch(url)
    .then(r => {
      if (!r.ok) throw new Error("Respuesta no OK del servidor");
      return r.json();
    })
    .then(products => {
      allProducts = Array.isArray(products) ? products : [];
      if (!allProducts.length) {
        showError(slugValue ? "No se encontraron productos para esta tienda." : "No hay productos para mostrar.");
        return;
      }
      applyFilters();
    })
    .catch(err => {
      console.error("Error al obtener productos:", err);
      showError("Hubo un problema al cargar los productos. Intenta nuevamente.");
    });
}

/* ================== Filtro + orden ================== */
function applyFilters() {
  const query = (searchInput?.value || "").trim().toLowerCase();
  const stockOnly = !!stockToggle?.checked;

  let filtered = allProducts.filter(p =>
    p.name.toLowerCase().includes(query) ||
    p.description.toLowerCase().includes(query)
  );

  if (stockOnly) filtered = filtered.filter(p => p.stock > 0);

  const sorted = [...filtered].sort((a,b) => (b.promotion === true) - (a.promotion === true));
  renderProducts(sorted);
}

/* ================== Pintado de cards ================== */
function renderProducts(products) {
  const grid = document.getElementById("products-grid");
  if (!grid) return;
  grid.innerHTML = "";

  products.forEach(product => {
    const card = document.createElement("div");
    card.className = `
      relative
      ${product.promotion ? "glow-card" : ""}
      bg-white rounded-2xl hover:scale-[1.02]
      transition-transform duration-300
      p-4 flex flex-col w-full max-w-xs
      opacity-0 translate-y-4
    `;

    if (product.promotion) {
      const promoBadge = document.createElement("div");
      promoBadge.textContent = "ðŸŽ‰ Â¡PROMO!";
      promoBadge.className = "absolute top-2 left-2 bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded shadow";
      card.appendChild(promoBadge);
    }

    const image = document.createElement("img");
    image.src = product.image_url;
    image.alt = product.name;
    image.className = "w-full h-40 object-cover rounded-lg mb-3";

    const name = document.createElement("h2");
    name.className = "text-lg font-semibold mb-1";

    const q = (searchInput?.value || "").trim().toLowerCase();
    if (q && product.name.toLowerCase().includes(q)) {
      name.innerHTML = product.name.replace(new RegExp(`(${q})`, "gi"), "<mark>$1</mark>");
    } else {
      name.textContent = product.name;
    }

    const desc = document.createElement("p");
    desc.textContent = product.description;
    desc.className = "text-sm text-gray-600 mb-2 w-full overflow-hidden whitespace-nowrap text-ellipsis";

    const toggleBtn = document.createElement("button");
    toggleBtn.textContent = "Ver mÃ¡s";
    toggleBtn.className = "text-sm text-blue-600 underline mb-2 text-left w-fit hidden transition-opacity duration-200";
    toggleBtn.style.minHeight = "1.5rem";

    requestAnimationFrame(() => {
      setTimeout(() => {
        toggleBtn.classList.remove("hidden");
        toggleBtn.style.visibility = desc.scrollWidth > desc.clientWidth ? "visible" : "hidden";
        card.classList.remove("opacity-0","translate-y-4");
        card.classList.add("opacity-100","translate-y-0");
      }, 0);
    });

    toggleBtn.addEventListener("click", () => {
      const isTruncated = desc.classList.contains("overflow-hidden");
      desc.className = isTruncated
        ? "text-sm text-gray-600 mb-2 w-full whitespace-normal"
        : "text-sm text-gray-600 mb-2 w-full overflow-hidden whitespace-nowrap text-ellipsis";
      toggleBtn.textContent = isTruncated ? "Ver menos" : "Ver mÃ¡s";
    });

    const price = document.createElement("p");
    price.className = "text-red-600 text-lg font-bold mb-3";
    price.textContent = `S/ ${Number(product.price).toFixed(2)}`;

    const stock = document.createElement("p");
    stock.className = `text-sm font-semibold mb-1 ${product.stock <= 0 ? "text-red-600" : "text-gray-700"}`;
    stock.textContent = product.stock <= 0 ? "Sin stock" : `Stock: ${product.stock}`;

    // WhatsApp: usa el de la tienda si viene, si no el fallback de pruebas
    //const shopWa = product.shop?.whatsapp_number;
    const waNumber = shopWa ? `51${shopWa}`.replace(/\D/g,"") : "51922540931"; // normaliza (solo dÃ­gitos)
    // BotÃ³n WhatsApp (usa el nÃºmero de la tienda si existe; si no, fallback)
    const shopWa = toPeruE164(product?.shop?.whatsapp_number) || "51922540931";
    const whatsappBtn = document.createElement("a");
    whatsappBtn.href = `https://wa.me/${shopWa}?text=${encodeURIComponent(
      `Hola, estoy interesado en el producto: ${product.name}`
    )}`;
    whatsappBtn.target = "_blank";
    whatsappBtn.rel = "noopener noreferrer";
    whatsappBtn.className = "bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-4 rounded text-center mt-1";
    whatsappBtn.textContent = "WhatsApp";

    // BotÃ³n de pago por QR (si existe el modal)
    const qrBtn = document.createElement("button");
    qrBtn.textContent = "Pagar por QR";
    qrBtn.className = `text-white font-semibold py-1 px-4 rounded text-center mt-1 ${product.stock <= 0 ? "bg-gray-400 cursor-not-allowed" : "bg-purple-600 hover:bg-purple-700"}`;
    qrBtn.disabled = product.stock <= 0;
    qrBtn.onclick = () => {
      if (!qrModal || product.stock <= 0) return;

      currentProduct = product;
      currentMethod  = null;
      hideAllQRs();
      qrModal.showModal();

      // si quieres mostrar nÃºmero Yape/Plin en el modal:
      const payNumberTextEl = document.getElementById("payNumberText");
      // usa yape/plin de la tienda si existen; si no, muestra el WhatsApp como referencia
      const modalNumber = currentProduct?.shop?.yape_number
                      || currentProduct?.shop?.plin_number
                      || currentProduct?.shop?.whatsapp_number
                      || "";
      if (payNumberTextEl) payNumberTextEl.textContent = modalNumber || "â€”";

      if (qrPriceText) {
        qrPriceText.innerHTML = `S/ ${Number(product.price).toFixed(2)}<br><span class='text-sm text-gray-600'>(~ ${(product.price / exchangeRate).toFixed(2)} USDT)</span>`;
      }

      if (notifyBtn) {
        notifyBtn.disabled = true;
        notifyBtn.textContent = "âš ï¸ Selecciona un mÃ©todo de pago";
        notifyBtn.className = "block mt-6 w-full bg-gray-800 text-white py-2 rounded text-center font-semibold opacity-50 pointer-events-none";
        notifyBtn.href = "#";
      }
    };

    const buttonContainer = document.createElement("div");
    buttonContainer.className = "flex flex-col gap-2 mt-2";
    buttonContainer.appendChild(whatsappBtn);
    buttonContainer.appendChild(qrBtn);

    card.appendChild(image);
    card.appendChild(name);
    card.appendChild(desc);
    card.appendChild(toggleBtn);
    card.appendChild(price);
    card.appendChild(stock);
    card.appendChild(buttonContainer);

    grid.appendChild(card);
  });
}

// Convierte "922540931" o "51922540931" a "51922540931"
function toPeruE164(raw) {
  const digits = String(raw || "").replace(/\D/g, "");
  if (!digits) return "";                 // sin nÃºmero
  return digits.startsWith("51") ? digits : `51${digits}`;
}

/* ================== Link WhatsApp del modal ================== */
function updateWhatsAppLink() {
  if (!notifyBtn) return;

  if (!currentProduct || !currentMethod) {
    const shopWa = toPeruE164(currentProduct?.shop?.whatsapp_number) || "51922540931";
    const text = `Hola, ya realicÃ© el pago por *${currentMethod}* del producto *${currentProduct.name}* por el monto de S/ ${currentProduct.price.toFixed(2)}. Adjunto comprobante.`;
    notifyBtn.href = `https://wa.me/${shopWa}?text=${encodeURIComponent(text)}`;
    notifyBtn.textContent = "âš ï¸ Selecciona un mÃ©todo de pago";
    notifyBtn.className = "block mt-6 w-full bg-gray-800 text-white py-2 rounded text-center font-semibold opacity-50 pointer-events-none";
    return;
  }

  const text = `Hola, ya realicÃ© el pago por *${currentMethod}* del producto *${currentProduct.name}* por el monto de S/ ${Number(currentProduct.price).toFixed(2)}. Adjunto comprobante.`;
  // usa el WhatsApp de la tienda si existe
  const wa = currentProduct.shop?.whatsapp_number ? `51${String(currentProduct.shop.whatsapp_number).replace(/\D/g,"")}` : "51922540931";
  notifyBtn.href = `https://wa.me/${wa}?text=${encodeURIComponent(text)}`;
  notifyBtn.textContent = "âœ… Ya paguÃ© - Notificar por WhatsApp";
  notifyBtn.className = "block mt-6 w-full text-white py-2 rounded text-center font-semibold bg-green-600 hover:bg-green-700";
  notifyBtn.classList.remove("pointer-events-none", "opacity-50");
}

/* ================== Cerrar modal tras â€œYa paguÃ©â€ (si existe) ================== */
if (notifyBtn && qrModal) {
  notifyBtn.addEventListener("click", (e) => {
    if (!currentProduct || !currentMethod) {
      e.preventDefault();
      return;
    }
    qrModal.classList.add("dialog-closing");
    qrModal.addEventListener(
      "animationend",
      () => {
        qrModal.classList.remove("dialog-closing");
        qrModal.close();
      },
      { once: true }
    );
  });
}


<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>âœ¨ Mi Tienda</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(to bottom right, #3f5270, #34456c); }
    .glow-card {
      box-shadow:
        0 0 15px rgba(255, 34, 0, 0.354),
        0 0 25px rgba(255, 98, 0, 0.6),
        0 0 45px rgba(255, 145, 0, 0.254);
      transition: box-shadow 0.3s ease, transform 0.3s ease;
    }
    .glow-card:hover {
      box-shadow:
        0 0 25px rgba(255, 68, 0, 0.402),
        0 0 50px rgba(255, 174, 0, 0.303),
        0 0 80px rgba(255, 132, 0, 0.285);
      transform: scale(1.05);
    }
    dialog::backdrop { background: rgba(0,0,0,.5); }
    @keyframes fadeOut { from { opacity:1; transform: scale(1);} to { opacity:0; transform: scale(.97);} }
    .dialog-closing { animation: fadeOut .25s ease forwards; }

  </style>
</head>
<body class="text-gray-800">

  <div class="max-w-7xl mx-auto px-4 py-6">
    <h1 class="text-4xl font-extrabold mb-10 text-center text-yellow-400 drop-shadow-md tracking-wide">
      âœ¨ Mi Tienda âœ¨
    </h1>

    <!-- Filtros -->
    <form id="search-form" class="mb-8 text-center space-y-2">
      <input
        id="search-input"
        type="text"
        placeholder="ðŸ” Buscar producto..."
        class="px-4 py-2 rounded-lg border border-gray-300 shadow-sm focus:outline-none focus:ring focus:ring-yellow-400 w-full max-w-md"
      />

      <!-- Slug opcional (para ver productos de una tienda especÃ­fica) -->
      <input
        id="shop-slug"
        type="text"
        placeholder="Slug de tienda (opcional, p.ej. max-store)"
        class="px-4 py-2 rounded-lg border border-gray-300 shadow-sm focus:outline-none focus:ring focus:ring-yellow-400 w-full max-w-md"
      />

      <!-- Toggle Solo con stock -->
      <div class="flex items-center justify-center">
        <label for="stockOnlyToggle" class="flex items-center cursor-pointer">
          <span class="text-white font-semibold mr-3">Solo con stock</span>
          <div class="relative">
            <input type="checkbox" id="stockOnlyToggle" class="sr-only peer" />
            <div class="w-11 h-6 bg-black rounded-full peer-checked:bg-yellow-400 transition-colors duration-300"></div>
            <div class="absolute top-0.5 left-0.5 bg-white w-5 h-5 rounded-full transition-transform duration-300 peer-checked:translate-x-5"></div>
          </div>
        </label>
      </div>
    </form>

    <!-- Grid de productos -->
    <div id="products-grid" class="grid gap-6 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>
  </div>

  <!-- ========= Modal de Pago por QR ========= -->
  <dialog id="qrModal" class="rounded-xl shadow-2xl p-6 max-w-sm w-full bg-white">
    <h2 class="text-2xl font-bold text-center mb-4 text-indigo-800">Pagar por QR</h2>

    <div class="space-y-4">
      <!-- Precio -->
      <p id="qrPriceText" class="text-center font-semibold text-red-600 text-xl"></p>

      <!-- ImÃ¡genes de QRs (ocultas por defecto) -->
      <img id="izipayQR"  src="img/izipay.jpg"  alt="QR Izipay"  class="w-full rounded-md hidden">
      <img id="binanceQR" src="img/binance.jpg" alt="QR Binance" class="w-full rounded-md hidden">
      <img id="yapeQR"    src="img/yape.jpg"    alt="QR Yape"    class="w-full rounded-md hidden">
      <img id="plinQR"    src="img/plin.jpg"    alt="QR Plin"    class="w-full rounded-md hidden">

      <!-- NÃºmero Yape/Plin (solo se muestra para esos mÃ©todos) -->
      <div id="yapePlinNumber" class="text-center text-gray-800 hidden">
        <p class="text-2xl font-bold">
          <span class="text-gray-600">NÃºmero:</span>
          <span class="text-black tracking-wider">
            <!-- AquÃ­ puedes mostrar el nÃºmero de tienda si luego lo quieres pintar -->
            <span id="payNumberText">â€”</span>
          </span>
        </p>
        <p class="text-base mt-1">
          Enviar el pago por <strong id="payMethodLabel" class="capitalize text-indigo-700">Yape</strong>.
        </p>
      </div>

      <!-- Botones de mÃ©todo de pago -->
      <div class="flex flex-wrap justify-center gap-2 mt-4">
        <button onclick="showIzipay()"  class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-1 px-4 rounded shadow">Izipay</button>
        <button onclick="showBinance()" class="bg-gray-700  hover:bg-gray-800  text-white font-semibold py-1 px-4 rounded shadow">Binance</button>
        <button onclick="showYape()"    class="bg-fuchsia-700 hover:bg-fuchsia-800 text-white font-semibold py-1 px-4 rounded shadow">Yape</button>
        <button onclick="showPlin()"    class="bg-blue-800    hover:bg-blue-900    text-white font-semibold py-1 px-4 rounded shadow">Plin</button>
      </div>
    </div>

    <!-- BotÃ³n WhatsApp (se habilita al elegir mÃ©todo) -->
    <a id="notifyWhatsAppBtn"
      href="#"
      target="_blank"
      rel="noopener noreferrer"
      class="block mt-6 w-full bg-gray-800 text-white py-2 rounded text-center font-semibold opacity-50 pointer-events-none">
      âš  Selecciona un mÃ©todo de pago
    </a>

    <!-- Cerrar -->
    <button id="closeModalBtn" class="mt-3 w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded shadow">Cerrar</button>
  </dialog>

  <footer class="text-center text-sm text-gray-300 py-6 mt-10">
    &copy; 2025 Mi Tienda. Todos los derechos reservados.
  </footer>

  

  <!-- Script principal -->
  <script src="/frontend/js/main.js"></script>
</body>
</html>
