// /frontend/seller/login.js
(() => {
  const form   = document.getElementById("login-form");
  const userEl = document.getElementById("username");
  const passEl = document.getElementById("password");
  const errEl  = document.getElementById("error-msg");

  if (!form) return;

  const showError = (msg) => {
    if (!errEl) return;
    errEl.textContent = msg || "Error de autenticación.";
    errEl.classList.remove("hidden");
  };

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (errEl) { errEl.classList.add("hidden"); errEl.textContent = ""; }

    const username = (userEl?.value || "").trim();
    const password = (passEl?.value || "").trim();
    if (!username || !password) {
      showError("Completa usuario y contraseña.");
      return;
    }

    try {
      // IMPORTANTE: enviar como x-www-form-urlencoded (lo que espera OAuth2PasswordRequestForm)
      const body = new URLSearchParams({ username, password });

      const res = await fetch("http://127.0.0.1:8000/user/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      let data = null;
      try { data = await res.json(); } catch { data = null; }

      if (!res.ok) {
        let message = "Credenciales inválidas.";
        const d = data?.detail;
        if (d) {
          if (Array.isArray(d)) {
            message = d.map(x => x.msg || x.detail || JSON.stringify(x)).join(" / ");
          } else if (typeof d === "string") {
            message = d;
          }
        }
        showError(message);
        return;
      }

      const { access_token, token_type, role } = (data || {});
      if (!access_token) {
        showError("Respuesta inesperada del servidor.");
        return;
      }

      localStorage.setItem("auth_token", access_token);
      localStorage.setItem("token_type", token_type || "bearer");
      if (role) localStorage.setItem("user_role", role);

      // Redirige al panel
      window.location.replace("/frontend/seller/dashboard.html");
    } catch (err) {
      console.error(err);
      showError("No se pudo conectar con el servidor.");
    }
  });
})();